<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName sikeskoja.portnumbay.id
    ServerAdmin admin@portnumbay.id

    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off

    # WebSocket support for API - must be before ProxyPass
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /api/(.*)  ws://localhost:5000/api/$1 [P,L]

    # Frontend static files - serve from Nginx (order matters!)
    ProxyPass /static http://localhost:8080/static nocanon
    ProxyPassReverse /static http://localhost:8080/static

    # API - proxy to Node.js backend  
    ProxyPass /api http://localhost:5000/api nocanon
    ProxyPassReverse /api http://localhost:5000/api

    # Uploads directory
    ProxyPass /uploads http://localhost:5000/uploads nocanon
    ProxyPassReverse /uploads http://localhost:5000/uploads

    # Health check
    ProxyPass /health http://localhost:5000/health nocanon
    ProxyPassReverse /health http://localhost:5000/health

    # All other requests to frontend (Nginx) - LAST!
    ProxyPass / http://localhost:8080/ nocanon
    ProxyPassReverse / http://localhost:8080/

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/sikeskoja-error.log
    CustomLog ${APACHE_LOG_DIR}/sikeskoja-access.log combined

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

SSLCertificateFile /etc/letsencrypt/live/sikeskoja.portnumbay.id/fullchain.pem
SSLCertificateKeyFile /etc/letsencrypt/live/sikeskoja.portnumbay.id/privkey.pem
Include /etc/letsencrypt/options-ssl-apache.conf
</VirtualHost>
</IfModule>
